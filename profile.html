<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Connect - MoKen</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#e50914">
  <meta name="description" content="Stream movies, TV shows, and music anytime, anywhere">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Panyero">
  
  <!-- PWA Icons -->
  <link rel="icon" href="/assets/images/icons/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="/assets/images/icons/icon-192x192.png">
  <link rel="manifest" href="/manifest.json">
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="./assets/css/style.css" />
  <style>
    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      padding-bottom: 80px;
    }
    
    .profile-container {
      padding: 80px 20px 20px;
    }
    
    .profile-header {
      display: flex;
      align-items: center;
      margin-bottom: 30px;
    }
    
    .profile-avatar-large {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background-color: #e50914;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: bold;
      margin-right: 20px;
    }
    
    .profile-info {
      flex: 1;
    }
    
    .profile-name {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .profile-id {
      font-size: 12px;
      color: var(--on-surface-variant);
      word-break: break-all;
    }
    
    .token-card {
      background-color: var(--surface);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .token-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .token-title {
      font-size: 18px;
      font-weight: 500;
    }
    
    .token-balance {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 15px;
      color: #e50914;
    }
    
    .token-subtitle {
      font-size: 14px;
      color: var(--on-surface-variant);
      margin-bottom: 20px;
    }
    
    .token-actions {
      display: flex;
      gap: 10px;
    }
    
    .token-btn {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      border: none;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .token-btn-primary {
      background-color: #e50914;
      color: white;
    }
    
    .token-btn-secondary {
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
    }
    
    .section-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .content-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .content-card {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      background-color: var(--surface);
    }
    
    .content-poster {
      aspect-ratio: 2/3;
      position: relative;
    }
    
    .content-poster img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .content-info {
      padding: 10px;
    }
    
    .content-title {
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 5px;
    }
    
    .content-meta {
      font-size: 12px;
      color: var(--on-surface-variant);
    }
    
    .content-progress {
      height: 3px;
      background-color: rgba(255, 255, 255, 0.2);
      position: relative;
      margin-top: 8px;
    }
    
    .content-progress-bar {
      height: 100%;
      background-color: #e50914;
      width: 0%;
    }
    
    .empty-state {
      text-align: center;
      padding: 30px;
      color: var(--on-surface-variant);
    }
    
    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 15px;
      opacity: 0.5;
    }
    
    .empty-state-title {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 10px;
    }
    
    .empty-state-text {
      font-size: 14px;
    }
    
    /* Connect wallet and redeem modals */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    
    .modal.active {
      opacity: 1;
      visibility: visible;
    }
    
    .modal-content {
      background-color: var(--surface);
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 20px;
      position: relative;
    }
    
    .modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .connect-options,
    .payment-options {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .connect-option,
    .payment-option,
    .token-package {
      cursor: pointer;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
    }
    
    .form-input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
    }
    
    .submit-btn {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: none;
      background-color: #e50914;
      color: white;
      font-weight: 500;
      cursor: pointer;
      margin-top: 10px;
    }
    
    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: #000;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
    }
    
    .nav-item {
      text-align: center;
      color: white;
      text-decoration: none;
    }
    
    .nav-item.active {
      color: #e50914;
    }
    
    .nav-icon {
      width: 24px;
      height: 24px;
    }
    
    /* Loading Spinner */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <a href="./index.html" class="logo-text">MOKEN</a>
    <div class="header-actions">
      <button class="search-btn" search-toggler>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </button>
      <div class="profile-avatar">
        <span>P</span>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main>
    <!-- Search Modal -->
    <div class="search-modal" search-modal>
      <div class="search-header">
        <button class="search-close" search-toggler>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
        <input type="text" class="search-input" placeholder="Search for movies..." search-field>
      </div>
      <div class="search-results" grid-list></div>
    </div>

    <!-- Profile Content -->
    <div class="profile-container">
      <!-- Profile Header -->
      <div class="profile-header">
        <div class="profile-avatar-large">
          <span>P</span>
        </div>
        <div class="profile-info">
          <h1 class="profile-name">MoKen User</h1>
          <p class="profile-id" id="profile-id">Not connected</p>
        </div>
      </div>
      
      <!-- Token Card -->
      <div class="token-card">
        <div class="token-header">
          <h2 class="token-title">MKO Balance</h2>
          <div id="connection-status" class="token-subtitle">Not connected</div>
        </div>
        <div class="token-balance" id="token-balance">0</div>
        <p class="token-subtitle">1 movie = 20 MKO</p>
        <div class="token-actions">
          <button class="token-btn token-btn-primary" id="buy-tokens-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </svg>
            <span>Buy MKO</span>
          </button>
          <button class="token-btn token-btn-secondary" id="connect-wallet-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
            </svg>
            <span id="connect-wallet-text">Connect</span>
          </button>
        </div>
      </div>
      
      <div class="token-card">
        <div class="token-header">
          <h2 class="token-title">Share & Earn MKO</h2>
        </div>
        <p class="token-subtitle">Share your referral link with friends and earn 100 MKO for each new user who connects!</p>
        
        <div class="referral-link-container">
          <input type="text" id="referral-link" class="referral-link" readonly>
          <button id="copy-referral" class="token-btn token-btn-secondary">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
            </svg>
            <span>Copy</span>
          </button>
        </div>
        
        <div class="share-buttons">
          <button class="share-button" id="share-whatsapp">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="#25D366">
              <path d="M16.75 13.96c.25.13.41.2.46.3.06.11.04.61-.21 1.18-.2.56-1.24 1.1-1.7 1.12-.46.02-.47.36-2.96-.73-2.49-1.09-3.99-3.75-4.11-3.92-.12-.17-.96-1.38-.92-2.61.05-1.22.69-1.8.95-2.04.24-.26.51-.29.68-.26h.47c.15 0 .36-.06.55.45l.69 1.87c.06.13.1.28.01.44l-.27.41-.39.42c-.12.12-.26.25-.12.5.12.26.62 1.09 1.32 1.78.91.88 1.71 1.17 1.95 1.3.24.14.39.12.54-.04l.81-.94c.19-.25.35-.19.58-.11l1.67.88M12 2a10 10 0 0 1 10 10 10 10 0 0 1-10 10c-1.97 0-3.8-.57-5.35-1.55L2 22l1.55-4.65A9.969 9.969 0 0 1 2 12 10 10 0 0 1 12 2m0 2a8 8 0 0 0-8 8c0 1.72.54 3.31 1.46 4.61L4.5 19.5l2.89-.96A7.95 7.95 0 0 0 12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8z"/>
            </svg>
          </button>
          <button class="share-button" id="share-telegram">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="#0088cc">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69.01-.03.01-.14-.05-.2-.06-.06-.17-.04-.25-.02-.11.02-1.84 1.17-5.2 3.42-.49.33-.94.5-1.35.48-.44-.02-1.29-.25-1.92-.46-.78-.26-1.39-.4-1.34-.85.03-.22.32-.45.88-.68 3.49-1.51 5.82-2.51 6.98-3 3.32-1.38 4.01-1.62 4.46-1.63.1 0 .32.02.46.19.12.13.15.31.17.5z"/>
            </svg>
          </button>
          <button class="share-button" id="share-twitter">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="#1DA1F2">
              <path d="M22.46 6c-.77.35-1.6.58-2.46.69.88-.53 1.56-1.37 1.88-2.38-.83.5-1.75.85-2.72 1.05C18.37 4.5 17.26 4 16 4c-2.35 0-4.27 1.92-4.27 4.29 0 .34.04.67.11.98C8.28 9.09 5.11 7.38 3 4.79c-.37.63-.58 1.37-.58 2.15 0 1.49.75 2.81 1.91 3.56-.71 0-1.37-.2-1.95-.5v.03c0 2.08 1.48 3.82 3.44 4.21a4.22 4.22 0 0 1-1.93.07 4.28 4.28 0 0 0 4 2.98 8.521 8.521 0 0 1-5.33 1.84c-.34 0-.68-.02-1.02-.06C3.44 20.29 5.7 21 8.12 21 16 21 20.33 14.46 20.33 8.79c0-.19 0-.37-.01-.56.84-.6 1.56-1.36 2.14-2.23z"/>
            </svg>
          </button>
          <button class="share-button" id="share-facebook">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="#1877F2">
              <path d="M12 2.04C6.5 2.04 2 6.53 2 12.06C2 17.06 5.66 21.21 10.44 21.96V14.96H7.9V12.06H10.44V9.85C10.44 7.34 11.93 5.96 14.22 5.96C15.31 5.96 16.45 6.15 16.45 6.15V8.62H15.19C13.95 8.62 13.56 9.39 13.56 10.18V12.06H16.34L15.89 14.96H13.56V21.96A10 10 0 0 0 22 12.06C22 6.53 17.5 2.04 12 2.04Z"/>
            </svg>
          </button>
        </div>
      </div>
      
      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" data-tab="history">Watch History</div>
        <div class="tab" data-tab="downloads">Downloads</div>
        <div class="tab" data-tab="transactions">Transactions</div>
      </div>
      
      <!-- Watch History Tab -->
      <div class="tab-content active" id="history-tab">
        <h2 class="section-title">Last Watched</h2>
        <div class="content-grid" id="watch-history-grid">
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5-9h10v2H7z"/>
            </svg>
            <h3 class="empty-state-title">No watch history</h3>
            <p class="empty-state-text">Your recently watched movies and shows will appear here</p>
          </div>
        </div>
      </div>
      
      <!-- Downloads Tab -->
      <div class="tab-content" id="downloads-tab">
        <h2 class="section-title">Downloads</h2>
        <div class="content-grid" id="downloads-grid">
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
            </svg>
            <h3 class="empty-state-title">No downloads</h3>
            <p class="empty-state-text">Your downloaded content will appear here</p>
          </div>
        </div>
      </div>
      
      <!-- Transactions Tab -->
      <div class="tab-content" id="transactions-tab">
        <h2 class="section-title">Transaction History</h2>
        <div class="transaction-list" id="transaction-list">
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
            </svg>
            <h3 class="empty-state-title">No transactions</h3>
            <p class="empty-state-text">Your MKO token transactions will appear here</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Connect Wallet Modal -->
  <div class="modal" id="connect-wallet-modal">
    <div class="modal-content">
      <button class="modal-close" id="connect-wallet-close">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
      <h2 class="modal-title">Connect to MoKen</h2>
      <div class="connect-options">
        <div class="connect-option" id="connect-panyero">
          <div class="connect-option-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
            </svg>
          </div>
          <div class="connect-option-info">
            <div class="connect-option-title">MoKen Wallet</div>
            <div class="connect-option-description">Connect using your MoKen account</div>
          </div>
        </div>
        
        <div class="connect-option" id="connect-device">
          <div class="connect-option-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"/>
            </svg>
          </div>
          <div class="connect-option-info">
            <div class="connect-option-title">This Device</div>
            <div class="connect-option-description">Connect using this device's unique ID</div>
          </div>
        </div>
        
        <div class="connect-option" id="connect-guest">
          <div class="connect-option-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
          </div>
          <div class="connect-option-info">
            <div class="connect-option-title">Guest Mode</div>
            <div class="connect-option-description">Connect as a guest with limited features</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Buy Tokens Modal -->
  <div class="modal" id="buy-tokens-modal">
    <div class="modal-content">
      <button class="modal-close" id="buy-tokens-close">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
      <h2 class="modal-title">Buy MKO Tokens</h2>
      
      <div class="token-packages">
        <div class="token-package" data-amount="1000" data-price="100">
          <div class="token-package-amount">1,000 MKO</div>
          <div class="token-package-price">₱100</div>
        </div>
        <div class="token-package" data-amount="2500" data-price="200">
          <div class="token-package-amount">2,500 MKO</div>
          <div class="token-package-price">₱200</div>
          <div class="token-package-best">+25% Bonus</div>
        </div>
        <div class="token-package" data-amount="5000" data-price="400">
          <div class="token-package-amount">5,000 MKO</div>
          <div class="token-package-price">₱400</div>
        </div>
        <div class="token-package" data-amount="10000" data-price="750">
          <div class="token-package-amount">10,000 MKO</div>
          <div class="token-package-price">₱750</div>
          <div class="token-package-best">Best Value</div>
        </div>
      </div>
      
      <div class="payment-options">
        <div class="payment-option" data-method="gcash">
          <div class="payment-option-icon">G</div>
          <div class="payment-option-info">
            <div class="payment-option-title">GCash</div>
            <div class="payment-option-description">Pay using your GCash account</div>
          </div>
        </div>
        
        <div class="payment-option" data-method="maya">
          <div class="payment-option-icon">M</div>
          <div class="payment-option-info">
            <div class="payment-option-title">Maya</div>
            <div class="payment-option-description">Pay using your Maya account</div>
          </div>
        </div>
        
        <div class="payment-option" data-method="card">
          <div class="payment-option-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/>
            </svg>
          </div>
          <div class="payment-option-info">
            <div class="payment-option-title">Credit/Debit Card</div>
            <div class="payment-option-description">Pay using your credit or debit card</div>
          </div>
        </div>
      </div>
      
      <div class="payment-form" id="payment-form" style="display: none;">
        <!-- GCash Form -->
        <div id="gcash-form" style="display: none;">
          <div class="form-group">
            <label class="form-label">GCash Mobile Number</label>
            <input type="tel" class="form-input" placeholder="09XX XXX XXXX" required>
          </div>
        </div>
        
        <!-- Maya Form -->
        <div id="maya-form" style="display: none;">
          <div class="form-group">
            <label class="form-label">Maya Account Number</label>
            <input type="tel" class="form-input" placeholder="09XX XXXX XXXX" required>
          </div>
        </div>
        
        <!-- Card Form -->
        <div id="card-form" style="display: none;">
          <div class="form-group">
            <label class="form-label">Card Number</label>
            <input type="text" class="form-input" placeholder="XXXX XXXX XXXX XXXX" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Expiry Date</label>
              <input type="text" class="form-input" placeholder="MM/YY" required>
            </div>
            <div class="form-group">
              <label class="form-label">CVV</label>
              <input type="text" class="form-input" placeholder="XXX" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Cardholder Name</label>
            <input type="text" class="form-input" placeholder="Name on card" required>
          </div>
        </div>
        
        <button class="submit-btn" id="payment-submit">
          <span id="payment-submit-text">Complete Purchase</span>
          <span class="loading-spinner" id="payment-spinner" style="display: none;"></span>
        </button>
      </div>
    </div>
  </div>

  <!-- Redeem Details Modal -->
  <div class="modal" id="redeem-modal">
    <div class="modal-content">
      <button class="modal-close" id="redeem-modal-close">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
      <h2 class="modal-title">Complete Your Profile</h2>
      <form id="redeem-form">
        <div class="form-group">
          <label class="form-label">Full Name</label>
          <input type="text" id="full-name" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">Phone Number</label>
          <input type="tel" id="phone-number" class="form-input" required>
        </div>
        <button type="submit" class="submit-btn">Redeem MKO</button>
      </form>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <a href="./index.html" class="nav-item">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8 12.5v-9l6 4.5-6 4.5z"></path>
      </svg>
      <span>Movies</span>
    </a>
    <a href="./tv-shows.html" class="nav-item">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M21 3H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h5v2h8v-2h5c1.1 0 1.99-.9 1.99-2L23 5c0-1.1-.9-2-2-2zm0 14H3V5h18v12z"></path>
      </svg>
      <span>TV Series</span>
    </a>
    <a href="./music.html" class="nav-item">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"></path>
      </svg>
      <span>Music</span>
    </a>
    <a href="./categories.html" class="nav-item">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9h-4v4h-2v-4H9V9h4V5h2v4h4v2z"></path>
      </svg>
      <span>Categories</span>
    </a>
    <a href="./profile.html" class="nav-item active">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.31-8.86c-1.77-.45-2.34-.94-2.34-1.67 0-.84.79-1.43 2.1-1.43 1.38 0 1.9.66 1.94 1.64h1.71c-.05-1.34-.87-2.57-2.49-2.97V5H10.9v1.69c-1.51.32-2.72 1.3-2.72 2.81 0 1.79 1.49 2.69 3.66 3.21 1.95.46 2.34 1.15 2.34 1.87 0 .53-.39 1.39-2.1 1.39-1.6 0-2.23-.72-2.32-1.64H8.04c.1 1.7 1.36 2.66 2.86 2.97V19h2.34v-1.67c1.52-.29 2.72-1.16 2.73-2.77-.01-2.2-1.9-2.96-3.66-3.42z"/>
      </svg>
      <span>Connect</span>
    </a>
  </nav>

  <!-- JavaScript -->
  <script src="./assets/js/global.js"></script>
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDTsjYZNWFfZOESP-2QQfbD7jc5fG9FJdc",
      authDomain: "explore-malaysia-6d28d.firebaseapp.com",
      databaseURL: "https://explore-malaysia-6d28d-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "explore-malaysia-6d28d",
      storageBucket: "explore-malaysia-6d28d.appspot.com",
      messagingSenderId: "869053244601",
      appId: "1:869053244601:web:29ad09ff454b43230be768",
      measurementId: "G-5XJK1H7KWX"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();

    // MKO Token Management with Firebase Integration
    class MKOTokenManager {
      constructor() {
        this.auth = firebase.auth();
        this.database = firebase.database();
        this.userData = this.loadUserData();
        this.checkForReferral();
        this.initializeUI();
        this.setupEventListeners();
        this.initializeFirebaseAuth();
      }

      // Initialize Firebase Authentication
      initializeFirebaseAuth() {
        this.auth.onAuthStateChanged(user => {
          if (user) {
            console.log("User is signed in:", user.uid);
            this.userData.firebaseUid = user.uid;
            this.userData.connected = true;
            this.saveUserData();
            this.syncUserDataWithFirebase();
            this.updateConnectionStatus();
            this.updateTokenBalance();
            this.updateReferralLink();
          } else {
            console.log("User is signed out");
            if (this.userData.connected) {
              this.userData.connected = false;
              this.userData.firebaseUid = null;
              this.saveUserData();
              this.updateConnectionStatus();
            }
          }
        });
      }

      // Sync user data with Firebase
      syncUserDataWithFirebase() {
        if (!this.userData.firebaseUid) return;
        const userRef = this.database.ref(`users/${this.userData.firebaseUid}`);
        userRef.once('value', snapshot => {
          const firebaseData = snapshot.val();
          if (firebaseData) {
            this.userData.balance = firebaseData.balance || this.userData.balance;
            this.userData.walletId = firebaseData.walletId || this.userData.walletId;
            this.userData.transactions = firebaseData.transactions || this.userData.transactions;
            this.userData.watchHistory = firebaseData.watchHistory || this.userData.watchHistory;
            this.userData.referrals = firebaseData.referrals || this.userData.referrals;
            this.userData.referredBy = firebaseData.referredBy || this.userData.referredBy;
            this.userData.authenticated = firebaseData.authenticated || this.userData.authenticated;
            this.saveUserData();
            this.updateUI();
          } else {
            userRef.set({
              walletId: this.userData.walletId || this.generateWalletId('firebase'),
              balance: this.userData.balance,
              transactions: this.userData.transactions || [],
              watchHistory: this.userData.watchHistory || [],
              referrals: this.userData.referrals || { count: 0, earned: 0, list: [] },
              referredBy: this.userData.referredBy || null,
              authenticated: this.userData.authenticated || false,
              lastUpdated: firebase.database.ServerValue.TIMESTAMP
            });
          }
        });
      }

      // Check for referral
      checkForReferral() {
        const urlParams = new URLSearchParams(window.location.search);
        const referrer = urlParams.get('ref');
        if (referrer && !this.userData.connected && !this.userData.referredBy) {
          this.userData.referredBy = referrer;
          this.saveUserData();
          console.log("Referral detected:", referrer);
        }
      }
      
      // Load user data from localStorage
      loadUserData() {
        const userData = localStorage.getItem('moken_user_data');
        if (userData) {
          return JSON.parse(userData);
        } else {
          return {
            connected: false,
            firebaseUid: null,
            walletId: null,
            balance: 0,
            watchHistory: [],
            transactions: [],
            lastConnected: null,
            referrals: { count: 0, earned: 0, list: [] },
            authenticated: false
          };
        }
      }
      
      // Save user data to localStorage
      saveUserData() {
        localStorage.setItem('moken_user_data', JSON.stringify(this.userData));
      }
      
      // Initialize UI elements
      initializeUI() {
        this.updateConnectionStatus();
        this.updateTokenBalance();
        this.loadWatchHistory();
        this.loadDownloads();
        this.loadTransactions();
        this.setupTabs();
        this.updateReferralLink();
        this.loadReferralStats();
      }

      // Update UI
      updateUI() {
        this.updateConnectionStatus();
        this.updateTokenBalance();
        this.loadWatchHistory();
        this.loadTransactions();
        this.updateReferralLink();
        this.loadReferralStats();
      }
      
      // Update connection status in UI
      updateConnectionStatus() {
        const connectionStatus = document.getElementById('connection-status');
        const connectWalletText = document.getElementById('connect-wallet-text');
        const profileId = document.getElementById('profile-id');
        
        if (this.userData.connected) {
          connectionStatus.textContent = 'Connected';
          connectionStatus.style.color = '#4CAF50';
          connectWalletText.textContent = 'Disconnect';
          profileId.textContent = this.userData.walletId || this.userData.firebaseUid;
        } else {
          connectionStatus.textContent = 'Not connected';
          connectionStatus.style.color = '';
          connectWalletText.textContent = 'Connect';
          profileId.textContent = 'Not connected';
        }
      }
      
      // Update token balance in UI
      updateTokenBalance() {
        const tokenBalance = document.getElementById('token-balance');
        tokenBalance.textContent = this.userData.balance.toLocaleString();
      }
      
      // Load watch history
      loadWatchHistory() {
        const watchHistoryGrid = document.getElementById('watch-history-grid');
        if (this.userData.watchHistory && this.userData.watchHistory.length > 0) {
          watchHistoryGrid.innerHTML = '';
          const sortedHistory = [...this.userData.watchHistory].sort((a, b) => b.watchedAt - a.watchedAt);
          const recentHistory = sortedHistory.slice(0, 6);
          recentHistory.forEach(item => {
            const card = document.createElement('div');
            card.className = 'content-card';
            const progressPercent = item.progress ? Math.min(Math.round((item.progress / item.duration) * 100), 100) : 0;
            card.innerHTML = `
              <div class="content-poster">
                <img src="${item.posterPath || '/assets/images/poster-bg-icon.png'}" alt="${item.title}" class="img-cover">
              </div>
              <div class="content-info">
                <div class="content-title">${item.title}</div>
                <div class="content-meta">${item.type === 'movie' ? 'Movie' : 'TV Show'}</div>
                <div class="content-progress">
                  <div class="content-progress-bar" style="width: ${progressPercent}%"></div>
                </div>
              </div>
            `;
            card.addEventListener('click', () => {
              if (item.type === 'movie') {
                window.localStorage.setItem('movieId', item.id);
                window.location.href = './detail.html';
              } else {
                window.localStorage.setItem('tvId', item.id);
                window.location.href = './tv-detail.html';
              }
            });
            watchHistoryGrid.appendChild(card);
          });
        } else {
          watchHistoryGrid.innerHTML = `
            <div class="empty-state">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5-9h10v2H7z"/>
              </svg>
              <h3 class="empty-state-title">No watch history</h3>
              <p class="empty-state-text">Your recently watched movies and shows will appear here</p>
            </div>
          `;
        }
      }
      
      // Load downloads
      loadDownloads() {
        const downloadsGrid = document.getElementById('downloads-grid');
        try {
          if (window.downloadManager) {
            window.downloadManager.getCompletedDownloads().then(downloads => {
              if (downloads && downloads.length > 0) {
                downloadsGrid.innerHTML = '';
                downloads.forEach(download => {
                  const card = document.createElement('div');
                  card.className = 'content-card';
                  card.innerHTML = `
                    <div class="content-poster">
                      <img src="${download.posterPath || '/assets/images/poster-bg-icon.png'}" alt="${download.title}" class="img-cover">
                    </div>
                    <div class="content-info">
                      <div class="content-title">${download.title}</div>
                      <div class="content-meta">${download.type === 'movie' ? 'Movie' : 'TV Show'}</div>
                    </div>
                  `;
                  card.addEventListener('click', () => {
                    window.location.href = `/offline-player.html?type=${download.type}&id=${download.id}`;
                  });
                  downloadsGrid.appendChild(card);
                });
              } else {
                this.showEmptyDownloads();
              }
            }).catch(error => {
              console.error('Error loading downloads:', error);
              this.showEmptyDownloads();
            });
          } else {
            this.showEmptyDownloads();
          }
        } catch (error) {
          console.error('Error accessing downloadManager:', error);
          this.showEmptyDownloads();
        }
      }
      
      showEmptyDownloads() {
        const downloadsGrid = document.getElementById('downloads-grid');
        downloadsGrid.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
            </svg>
            <h3 class="empty-state-title">No downloads</h3>
            <p class="empty-state-text">Your downloaded content will appear here</p>
          </div>
        `;
      }
      
      // Load transactions
      loadTransactions() {
        const transactionList = document.getElementById('transaction-list');
        if (this.userData.transactions && this.userData.transactions.length > 0) {
          transactionList.innerHTML = '';
          const sortedTransactions = [...this.userData.transactions].sort((a, b) => b.timestamp - a.timestamp);
          sortedTransactions.forEach(transaction => {
            const item = document.createElement('div');
            item.className = 'transaction-item';
            const date = new Date(transaction.timestamp);
            const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const isPositive = transaction.amount > 0;
            item.innerHTML = `
              <div class="transaction-info">
                <div class="transaction-title">${transaction.description}</div>
                <div class="transaction-date">${formattedDate}</div>
              </div>
              <div class="transaction-amount ${isPositive ? 'positive' : 'negative'}">
                ${isPositive ? '+' : ''}${transaction.amount} MKO
              </div>
            `;
            transactionList.appendChild(item);
          });
        } else {
          transactionList.innerHTML = `
            <div class="empty-state">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
              </svg>
              <h3 class="empty-state-title">No transactions</h3>
              <p class="empty-state-text">Your MKO token transactions will appear here</p>
            </div>
          `;
        }
      }
      
      // Setup tabs
      setupTabs() {
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            tabContents.forEach(content => content.classList.remove('active'));
            const tabId = tab.getAttribute('data-tab');
            document.getElementById(`${tabId}-tab`).classList.add('active');
          });
        });
      }
      
      // Setup event listeners
      setupEventListeners() {
        const connectWalletBtn = document.getElementById('connect-wallet-btn');
        connectWalletBtn.addEventListener('click', () => {
          if (this.userData.connected) {
            this.disconnectWallet();
          } else {
            this.showConnectWalletModal();
          }
        });
        
        const buyTokensBtn = document.getElementById('buy-tokens-btn');
        buyTokensBtn.addEventListener('click', () => {
          if (this.userData.connected) {
            this.showBuyTokensModal();
          } else {
            this.showConnectWalletModal();
          }
        });
        
        document.getElementById('connect-wallet-close').addEventListener('click', () => {
          this.hideConnectWalletModal();
        });
        document.getElementById('buy-tokens-close').addEventListener('click', () => {
          this.hideBuyTokensModal();
        });
        
        document.getElementById('connect-panyero').addEventListener('click', () => this.connectWallet('panyero'));
        document.getElementById('connect-device').addEventListener('click', () => this.connectWallet('device'));
        document.getElementById('connect-guest').addEventListener('click', () => this.connectWallet('guest'));
        
        document.querySelectorAll('.token-package').forEach(pkg => {
          pkg.addEventListener('click', () => {
            document.querySelectorAll('.token-package').forEach(p => p.classList.remove('selected'));
            pkg.classList.add('selected');
          });
        });
        
        document.querySelectorAll('.payment-option').forEach(option => {
          option.addEventListener('click', () => {
            const method = option.getAttribute('data-method');
            this.showPaymentForm(method);
          });
        });
        
        document.getElementById('payment-submit').addEventListener('click', () => {
          this.processPayment();
        });
        
        const copyReferralBtn = document.getElementById('copy-referral');
        if (copyReferralBtn) {
          copyReferralBtn.addEventListener('click', () => {
            const referralLink = document.getElementById('referral-link');
            referralLink.select();
            document.execCommand('copy');
            const originalText = copyReferralBtn.querySelector('span').textContent;
            copyReferralBtn.querySelector('span').textContent = 'Copied!';
            setTimeout(() => {
              copyReferralBtn.querySelector('span').textContent = originalText;
            }, 2000);
          });
        }
        
        const shareWhatsApp = document.getElementById('share-whatsapp');
        if (shareWhatsApp) {
          shareWhatsApp.addEventListener('click', () => {
            const referralLink = document.getElementById('referral-link').value;
            const shareText = encodeURIComponent(`Join Panyero and get 1000 MKO tokens for free! Use my referral link: ${referralLink}`);
            window.open(`https://wa.me/?text=${shareText}`, '_blank');
          });
        }
        
        const shareTelegram = document.getElementById('share-telegram');
        if (shareTelegram) {
          shareTelegram.addEventListener('click', () => {
            const referralLink = document.getElementById('referral-link').value;
            const shareText = encodeURIComponent(`Join Panyero and get 1000 MKO tokens for free! Use my referral link: ${referralLink}`);
            window.open(`https://t.me/share/url?url=${referralLink}&text=${shareText}`, '_blank');
          });
        }
        
        const shareTwitter = document.getElementById('share-twitter');
        if (shareTwitter) {
          shareTwitter.addEventListener('click', () => {
            const referralLink = document.getElementById('referral-link').value;
            const shareText = encodeURIComponent(`Join Panyero and get 1000 MKO tokens for free! Use my referral link: ${referralLink}`);
            window.open(`https://twitter.com/intent/tweet?text=${shareText}`, '_blank');
          });
        }
        
        const shareFacebook = document.getElementById('share-facebook');
        if (shareFacebook) {
          shareFacebook.addEventListener('click', () => {
            const referralLink = document.getElementById('referral-link').value;
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(referralLink)}`, '_blank');
          });
        }
        
        // Redeem modal events
        document.getElementById('redeem-modal-close').addEventListener('click', () => {
          this.hideRedeemModal();
        });
        
        document.getElementById('redeem-form').addEventListener('submit', (e) => {
          e.preventDefault();
          this.processRedeem();
        });
      }
      
      // Show connect wallet modal
      showConnectWalletModal() {
        document.getElementById('connect-wallet-modal').classList.add('active');
      }
      
      hideConnectWalletModal() {
        document.getElementById('connect-wallet-modal').classList.remove('active');
      }
      
      showBuyTokensModal() {
        document.getElementById('buy-tokens-modal').classList.add('active');
        document.getElementById('payment-form').style.display = 'none';
        document.getElementById('gcash-form').style.display = 'none';
        document.getElementById('maya-form').style.display = 'none';
        document.getElementById('card-form').style.display = 'none';
        document.querySelectorAll('.token-package').forEach(p => p.classList.remove('selected'));
      }
      
      hideBuyTokensModal() {
        document.getElementById('buy-tokens-modal').classList.remove('active');
      }
      
      showPaymentForm(method) {
        const paymentForm = document.getElementById('payment-form');
        const gcashForm = document.getElementById('gcash-form');
        const mayaForm = document.getElementById('maya-form');
        const cardForm = document.getElementById('card-form');
        paymentForm.style.display = 'block';
        gcashForm.style.display = 'none';
        mayaForm.style.display = 'none';
        cardForm.style.display = 'none';
        if (method === 'gcash') {
          gcashForm.style.display = 'block';
        } else if (method === 'maya') {
          mayaForm.style.display = 'block';
        } else if (method === 'card') {
          cardForm.style.display = 'block';
        }
        paymentForm.setAttribute('data-method', method);
      }
      
      processPayment() {
        const selectedPackage = document.querySelector('.token-package.selected');
        if (!selectedPackage) {
          alert('Please select a token package');
          return;
        }
        const amount = parseInt(selectedPackage.getAttribute('data-amount'));
        const price = parseInt(selectedPackage.getAttribute('data-price'));
        const paymentSubmitText = document.getElementById('payment-submit-text');
        const paymentSpinner = document.getElementById('payment-spinner');
        paymentSubmitText.style.display = 'none';
        paymentSpinner.style.display = 'inline-block';
        setTimeout(() => {
          this.userData.balance += amount;
          const transaction = {
            description: `Purchased ${amount.toLocaleString()} MKO`,
            amount: amount,
            timestamp: Date.now()
          };
          if (!this.userData.transactions) {
            this.userData.transactions = [];
          }
          this.userData.transactions.push(transaction);
          this.saveUserData();
          if (this.userData.firebaseUid) {
            const userRef = this.database.ref(`users/${this.userData.firebaseUid}`);
            userRef.update({
              balance: this.userData.balance,
              transactions: this.userData.transactions,
              lastUpdated: firebase.database.ServerValue.TIMESTAMP
            });
          }
          this.updateTokenBalance();
          this.loadTransactions();
          paymentSubmitText.style.display = 'inline-block';
          paymentSpinner.style.display = 'none';
          this.hideBuyTokensModal();
          alert(`Successfully purchased ${amount.toLocaleString()} MKO tokens!`);
        }, 2000);
      }
      
      // Connect wallet using Firebase anonymous auth
      connectWallet(type) {
        const connectWalletBtn = document.getElementById('connect-wallet-btn');
        connectWalletBtn.disabled = true;
        connectWalletBtn.innerHTML = '<span class="loading-spinner"></span>';
        this.auth.signInAnonymously()
          .then((userCredential) => {
            const user = userCredential.user;
            console.log("Anonymous user signed in:", user.uid);
            if (!this.userData.walletId) {
              this.userData.walletId = this.generateWalletId(type);
            }
            this.userData.connected = true;
            this.userData.firebaseUid = user.uid;
            this.userData.lastConnected = Date.now();
            const isNewUser = this.userData.balance === 0;
            if (isNewUser) {
              // Award 10,000 MKO tokens for new users
              this.userData.balance = 10000;
              if (!this.userData.transactions) {
                this.userData.transactions = [];
              }
              this.userData.transactions.push({
                description: 'Welcome bonus',
                amount: 10000,
                timestamp: Date.now()
              });
            }
            const userRef = this.database.ref(`users/${user.uid}`);
            userRef.once('value', snapshot => {
              if (!snapshot.exists()) {
                userRef.set({
                  walletId: this.userData.walletId,
                  balance: this.userData.balance,
                  transactions: this.userData.transactions,
                  watchHistory: this.userData.watchHistory || [],
                  referrals: this.userData.referrals || { count: 0, earned: 0, list: [] },
                  referredBy: this.userData.referredBy || null,
                  authenticated: this.userData.authenticated || false,
                  createdAt: firebase.database.ServerValue.TIMESTAMP,
                  lastUpdated: firebase.database.ServerValue.TIMESTAMP
                });
              } else {
                this.syncUserDataWithFirebase();
              }
            });
            this.saveUserData();
            this.updateConnectionStatus();
            this.updateTokenBalance();
            this.loadTransactions();
            this.updateReferralLink();
            this.hideConnectWalletModal();
            connectWalletBtn.disabled = false;
            connectWalletBtn.innerHTML = '<span>Disconnect</span>';
            // If the user is new and not yet authenticated, show the redeem modal
            if (isNewUser && !this.userData.authenticated) {
              this.showRedeemModal();
            }
          })
          .catch((error) => {
            console.error("Error signing in anonymously:", error);
            alert("Failed to connect: " + error.message);
            connectWalletBtn.disabled = false;
            connectWalletBtn.innerHTML = '<span>Connect</span>';
          });
      }
      
      // Disconnect wallet
      disconnectWallet() {
        this.auth.signOut()
          .then(() => {
            console.log("User signed out");
            this.userData.connected = false;
            this.userData.firebaseUid = null;
            this.saveUserData();
            this.updateConnectionStatus();
          })
          .catch((error) => {
            console.error("Error signing out:", error);
          });
      }

      // Credit referrer with 100 MKO
      creditReferrer(referrerId, newUserId) {
        console.log("Crediting referrer:", referrerId);
        const referrerRef = this.database.ref(`users`).orderByChild('walletId').equalTo(referrerId).limitToFirst(1);
        referrerRef.once('value', snapshot => {
          if (snapshot.exists()) {
            snapshot.forEach(childSnapshot => {
              const referrerUid = childSnapshot.key;
              const referrerData = childSnapshot.val();
              console.log("Found referrer:", referrerUid);
              const referrerUserRef = this.database.ref(`users/${referrerUid}`);
              if (!referrerData.referrals) {
                referrerData.referrals = { count: 0, earned: 0, list: [] };
              }
              referrerData.referrals.count++;
              referrerData.referrals.earned += 100;
              if (!referrerData.referrals.list) {
                referrerData.referrals.list = [];
              }
              referrerData.referrals.list.push({
                userId: newUserId,
                timestamp: Date.now()
              });
              referrerData.balance += 100;
              if (!referrerData.transactions) {
                referrerData.transactions = [];
              }
              referrerData.transactions.push({
                description: 'Referral bonus',
                amount: 100,
                timestamp: Date.now()
              });
              referrerUserRef.update({
                balance: referrerData.balance,
                transactions: referrerData.transactions,
                referrals: referrerData.referrals,
                lastUpdated: firebase.database.ServerValue.TIMESTAMP
              });
              console.log("Referrer credited with 100 MKO");
            });
          } else {
            console.log("Referrer not found:", referrerId);
          }
        });
      }
      
      // Update referral link
      updateReferralLink() {
        const referralLinkInput = document.getElementById('referral-link');
        if (referralLinkInput && this.userData.connected) {
          const baseUrl = 'https://moken.website/movie-connect/profile.html';
          const referralLink = `${baseUrl}?ref=${this.userData.walletId}`;
          referralLinkInput.value = referralLink;
        }
      }

      // Load referral stats
      loadReferralStats() {
        if (this.userData.referrals) {
          const referralStatsContainer = document.querySelector('.token-card:nth-child(2)');
          if (referralStatsContainer) {
            const existingStats = referralStatsContainer.querySelector('.referral-stats');
            if (existingStats) {
              existingStats.remove();
            }
            const statsHTML = `
              <div class="referral-stats">
                <div class="referral-stat">
                  <div class="referral-stat-value">${this.userData.referrals.count || 0}</div>
                  <div class="referral-stat-label">Referrals</div>
                </div>
                <div class="referral-stat">
                  <div class="referral-stat-value">${this.userData.referrals.earned || 0}</div>
                  <div class="referral-stat-label">MKO Earned</div>
                </div>
              </div>
            `;
            referralStatsContainer.insertAdjacentHTML('beforeend', statsHTML);
          }
        }
      }
      
      // Generate a unique wallet ID
      generateWalletId(type) {
        const prefix = 'MKO-';
        const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let result = prefix;
        for (let i = 0; i < 32; i++) {
          result += characters.charAt(Math.floor(Math.random() * characters.length));
        }
        return result;
      }
      
      // Add to watch history
      addToWatchHistory(item) {
        if (!this.userData.watchHistory) {
          this.userData.watchHistory = [];
        }
        const existingIndex = this.userData.watchHistory.findIndex(historyItem => historyItem.id === item.id);
        if (existingIndex !== -1) {
          this.userData.watchHistory[existingIndex] = {
            ...this.userData.watchHistory[existingIndex],
            ...item,
            watchedAt: Date.now()
          };
        } else {
          this.userData.watchHistory.push({
            ...item,
            watchedAt: Date.now()
          });
        }
        this.saveUserData();
        if (this.userData.firebaseUid) {
          const userRef = this.database.ref(`users/${this.userData.firebaseUid}`);
          userRef.update({
            watchHistory: this.userData.watchHistory,
            lastUpdated: firebase.database.ServerValue.TIMESTAMP
          });
        }
      }
      
      // Check if user can watch a movie
      canWatchMovie() {
        return this.userData.connected && this.userData.balance >= 20;
      }
      
      // Deduct tokens for watching a movie
      deductTokensForMovie(movieTitle, movieId) {
        if (!this.canWatchMovie()) {
          return false;
        }
        this.userData.balance -= 20;
        if (!this.userData.transactions) {
          this.userData.transactions = [];
        }
        this.userData.transactions.push({
          description: `Watched "${movieTitle}"`,
          amount: -20,
          timestamp: Date.now()
        });
        this.saveUserData();
        if (this.userData.firebaseUid) {
          const userRef = this.database.ref(`users/${this.userData.firebaseUid}`);
          userRef.update({
            balance: this.userData.balance,
            transactions: this.userData.transactions,
            lastUpdated: firebase.database.ServerValue.TIMESTAMP
          });
        }
        this.updateTokenBalance();
        this.loadTransactions();
        return true;
      }
      
      // Show Redeem Modal to capture full name and phone
      showRedeemModal() {
        document.getElementById('redeem-modal').classList.add('active');
      }
      
      hideRedeemModal() {
        document.getElementById('redeem-modal').classList.remove('active');
      }
      
      // Process Redeem form submission: update user data with full name and phone and mark authenticated
      processRedeem() {
        const fullName = document.getElementById('full-name').value.trim();
        const phoneNumber = document.getElementById('phone-number').value.trim();
        if (!fullName || !phoneNumber) {
          alert('Please enter your full name and phone number.');
          return;
        }
        this.userData.fullName = fullName;
        this.userData.phoneNumber = phoneNumber;
        this.userData.authenticated = true;
        this.saveUserData();
        if (this.userData.firebaseUid) {
          const userRef = this.database.ref(`users/${this.userData.firebaseUid}`);
          userRef.update({
            fullName: fullName,
            phoneNumber: phoneNumber,
            authenticated: true,
            lastUpdated: firebase.database.ServerValue.TIMESTAMP
          });
        }
        this.hideRedeemModal();
        alert('Profile updated! You can now redeem your MKO tokens.');
      }
    }
    
    const tokenManager = new MKOTokenManager();
    window.tokenManager = tokenManager;
    
    const originalGetMovieDetail = window.getMovieDetail;
    window.getMovieDetail = function(movieId) {
      window.localStorage.setItem("movieId", String(movieId));
    };
  </script>
</body>
</html>
